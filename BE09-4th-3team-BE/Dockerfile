# ---------------------------
# 1. ë¹Œë“œ ìŠ¤í…Œì´ì§€
# ---------------------------
FROM gradle:jdk17-alpine AS build

WORKDIR /app

# ëª¨ë“  ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬
COPY . .

# ğŸ›  ì„¤ì • íŒŒì¼ë„ ë³µì‚¬ (Jenkinsì—ì„œ ë¯¸ë¦¬ ìœ„ì¹˜ì— ë„£ì–´ì£¼ëŠ” ê²ƒì„ ì „ì œë¡œ í•¨)
COPY src/main/resources/secret.yml src/main/resources/secret.yml
COPY src/main/resources/keystore.p12 src/main/resources/keystore.p12

# Gradle ë¹Œë“œ (í…ŒìŠ¤íŠ¸ í¬í•¨)
RUN gradle clean build -x test --no-daemon

# ---------------------------
# 2. ì‹¤í–‰ ìŠ¤í…Œì´ì§€
# ---------------------------
FROM openjdk:17-alpine

WORKDIR /app

# ë¹Œë“œ ê²°ê³¼ JAR íŒŒì¼ ë³µì‚¬
COPY --from=build /app/build/libs/*.jar ./

# plain ì œì™¸ JARì„ app.jarë¡œ ë³€ê²½
RUN mv $(find . -maxdepth 1 -name "*.jar" ! -name "*plain*.jar") app.jar

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
ENTRYPOINT ["java", "-jar", "app.jar"]
